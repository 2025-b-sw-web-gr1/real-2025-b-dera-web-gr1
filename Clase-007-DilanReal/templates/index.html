{# HERENCIA DE PLANTILLAS: Extendemos la plantilla base #}
{% extends "base.html" %}

{% block title %}{{ titulo }} - AirPods Cases{% endblock %}

{# MACROS: Definici√≥n de una macro reutilizable para tarjetas de producto #}
{% macro render_product_card(producto) %}
<div class="product-card">
    <div class="product-image">
        <img src="{{ producto.imagen }}" 
             alt="{{ producto.nombre }}"
             loading="lazy">
        {# CONDICIONALES: Mostrar badge si es destacado #}
        {% if producto.destacado %}
        <span class="badge-destacado">‚≠ê Destacado</span>
        {% endif %}
    </div>
    <div class="product-info">
        {# FILTROS: Transformaci√≥n de datos #}
        <h3>{{ producto.nombre | title }}</h3>
        <p class="description">{{ producto.descripcion | truncate(80) }}</p>
        
        {# EXPRESIONES: C√°lculo de precio con IVA #}
        <div class="price-section">
            <span class="price">${{ "%.2f" | format(producto.precio) }}</span>
            <span class="price-tax">IVA inc: ${{ "%.2f" | format(producto.precio * 1.21) }}</span>
        </div>
        
        {# BUCLES: Mostrar colores disponibles #}
        <div class="colors">
            <strong>Colores:</strong>
            {% for color in producto.colores %}
                <span class="color-badge">{{ color }}</span>
                {# LOOP SPECIAL VARIABLE: A√±adir coma excepto en el √∫ltimo #}
                {% if not loop.last %}, {% endif %}
            {% endfor %}
        </div>
        
        {# CONDICIONALES: Estado del stock #}
        <div class="stock-info">
            {% if producto.stock > 20 %}
                <span class="stock-alto">‚úì Stock disponible ({{ producto.stock }} unidades)</span>
            {% elif producto.stock > 10 %}
                <span class="stock-medio">‚ö† Stock limitado ({{ producto.stock }} unidades)</span>
            {% else %}
                <span class="stock-bajo">‚ö° √öltimas unidades ({{ producto.stock }})</span>
            {% endif %}
        </div>
        
        <a href="{{ url_for('detalle_producto', producto_id=producto.id) }}" class="btn-ver-mas">Ver Detalles</a>
    </div>
</div>
{% endmacro %}

{% block content %}
<section class="hero">
    <div class="container">
        <div class="hero-content">
            <div class="hero-icon">üéß</div>
            <h1>{{ titulo }}</h1>
            <p class="hero-subtitle">Protege tus AirPods con estilo y calidad</p>
            {# FILTROS Y EXPRESIONES: Contar productos #}
            <p class="hero-stats">
                Tenemos <strong>{{ productos | length }}</strong> productos destacados para ti
            </p>
        </div>
    </div>
</section>

<section class="jinja2-features">
    <div class="container">
        <h2>üöÄ Caracter√≠sticas de Jinja2 en esta p√°gina</h2>
        <div class="features-grid">
            {# BUCLE CON DICCIONARIO #}
            {% for key, value in caracteristicas.items() %}
            <div class="feature-card">
                <h3>{{ key | replace('_', ' ') | title }}</h3>
                <p>{{ value }}</p>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<section class="productos-section">
    <div class="container">
        <h2>Productos Destacados</h2>
        
        {# CONDICIONAL: Verificar si hay productos #}
        {% if productos %}
            <div class="products-grid">
                {# USAR LA MACRO DEFINIDA ARRIBA #}
                {% for producto in productos %}
                    {{ render_product_card(producto) }}
                {% endfor %}
            </div>
        {% else %}
            <p class="no-products">No hay productos disponibles en este momento.</p>
        {% endif %}
        
        <div class="cta-section">
            <a href="{{ url_for('todos_productos') }}" class="btn-primary">Ver Cat√°logo Completo</a>
        </div>
    </div>
</section>

{# FILTROS AVANZADOS: Ejemplo de uso de m√∫ltiples filtros #}
<section class="stats-section">
    <div class="container">
        <h2>Estad√≠sticas del Cat√°logo</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <h3>{{ productos | length }}</h3>
                <p>Productos Destacados</p>
            </div>
            <div class="stat-card">
                {# FILTRO MAP + SUM: Suma de todos los stocks #}
                <h3>{{ productos | map(attribute='stock') | sum }}</h3>
                <p>Unidades en Stock</p>
            </div>
            <div class="stat-card">
                {# FILTRO MAP + LIST + LENGTH: Contar colores √∫nicos #}
                {% set all_colors = productos | map(attribute='colores') | sum(start=[]) %}
                <h3>{{ all_colors | unique | list | length }}</h3>
                <p>Colores Diferentes</p>
            </div>
            <div class="stat-card">
                {# C√ÅLCULO DE PRECIO PROMEDIO #}
                {% set avg_price = (productos | map(attribute='precio') | sum) / (productos | length) %}
                <h3>${{ "%.2f" | format(avg_price) }}</h3>
                <p>Precio Promedio</p>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    console.log('P√°gina cargada con Jinja2!');
    console.log('Productos destacados: {{ productos | length }}');
</script>
{% endblock %}
