{% extends "base.html" %}

{% block title %}{{ titulo }} - Todos los Productos{% endblock %}

{# IMPORTAR MACRO desde index.html (reutilizaci√≥n) #}
{# Como alternativa, podr√≠amos crear un archivo macros.html separado #}
{% macro render_product_card(producto) %}
<div class="product-card">
    <div class="product-image">
        <img src="{{ producto.imagen }}" 
             alt="{{ producto.nombre }}"
             loading="lazy">
        {% if producto.destacado %}
        <span class="badge-destacado">‚≠ê Destacado</span>
        {% endif %}
    </div>
    <div class="product-info">
        <h3>{{ producto.nombre }}</h3>
        <p class="description">{{ producto.descripcion }}</p>
        <div class="price-section">
            <span class="price">${{ "%.2f" | format(producto.precio) }}</span>
        </div>
        <div class="colors">
            <strong>Colores:</strong>
            {% for color in producto.colores %}
                <span class="color-badge">{{ color }}</span>
            {% endfor %}
        </div>
        <a href="{{ url_for('detalle_producto', producto_id=producto.id) }}" class="btn-ver-mas">Ver Detalles</a>
    </div>
</div>
{% endmacro %}

{% block content %}
<section class="page-header">
    <div class="container">
        <h1>{{ titulo }}</h1>
        <p>Explora nuestra colecci√≥n completa de fundas para AirPods</p>
    </div>
</section>

<section class="productos-section">
    <div class="container">
        {# FILTROS: Separar productos por categor√≠as usando selectattr #}
        {% set destacados = productos | selectattr('destacado') | list %}
        {% set normales = productos | rejectattr('destacado') | list %}
        
        {# Mostrar primero los destacados si existen #}
        {% if destacados %}
        <div class="section-destacados">
            <h2>‚≠ê Productos Destacados</h2>
            <div class="products-grid">
                {% for producto in destacados %}
                    {{ render_product_card(producto) }}
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        {# Luego mostrar los productos normales #}
        {% if normales %}
        <div class="section-normales">
            <h2>M√°s Productos</h2>
            <div class="products-grid">
                {% for producto in normales %}
                    {{ render_product_card(producto) }}
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        {# CONDICIONAL: Si no hay productos #}
        {% if not productos %}
        <div class="no-products">
            <p>üòî No hay productos disponibles en este momento.</p>
        </div>
        {% endif %}
    </div>
</section>

{# EJEMPLO DE TABLA CON JINJA2 #}
<section class="tabla-productos">
    <div class="container">
        <h2>Comparativa R√°pida</h2>
        <div class="table-responsive">
            <table class="products-table">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Precio</th>
                        <th>Precio + IVA</th>
                        <th>Colores</th>
                        <th>Stock</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    {# BUCLE con acceso a loop.index #}
                    {% for producto in productos | sort(attribute='precio') %}
                    <tr class="{{ 'destacado-row' if producto.destacado else '' }}">
                        <td>
                            <strong>{{ loop.index }}.</strong> {{ producto.nombre }}
                        </td>
                        <td>${{ "%.2f" | format(producto.precio) }}</td>
                        <td>${{ "%.2f" | format(producto.precio * 1.21) }}</td>
                        <td>{{ producto.colores | length }} opcion{{ 'es' if producto.colores | length > 1 else '' }}</td>
                        <td>{{ producto.stock }} uds.</td>
                        <td>
                            {% if producto.stock > 20 %}
                                <span class="status-disponible">Disponible</span>
                            {% elif producto.stock > 10 %}
                                <span class="status-limitado">Limitado</span>
                            {% else %}
                                <span class="status-agotandose">Pocas uds.</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="6">
                            <strong>Total de productos:</strong> {{ productos | length }} |
                            <strong>Stock total:</strong> {{ productos | map(attribute='stock') | sum }} unidades
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</section>
{% endblock %}
